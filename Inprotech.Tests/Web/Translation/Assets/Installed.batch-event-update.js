var BatchEventUpdateResources=function(a){"use strict";localise.initialize({title:"Batch Event Update",btnSave:"Save",btnSaveWithWarnings:"Save with Warnings",optSelectActionCaption:"Select an Action",optSelectEntryCaption:"Select an Entry",tooltipShowOnlyValidEntries:"Show only valid entries",tooltipShowAllEntries:"Show all entries",tooltipApplyToAll:"Apply to all",btnShowMatchingCases:"Show Matching Cases",validationAtleastOneDateRequired:"A date is required for atleast one of the following",validationCaseRestrictionsWarnings:"There are some warnings associated with one or more names in this case.",columnHeadingCaseRef:"Case Ref.",columnHeadingOfficialNo:"Official No.",columnHeadingFileLocation:"File Location",columnHeadingCycle:"Cycle",columnHeadingEventDate:"Event Date",columnHeadingDueDate:"Due Date",columnHeadingEventText:"Event Text",columnHeadingCaseStatus:"Case Status",columnHeadingTitle:"Title",columnHeadingReason:"Reason",headingWarnings:"Warnings",headingErrors:"Errors",stvMultipleCaseStatusChange:"The status of the following cases will be changed to: ",stvSingleCaseStatusChange:"This action will update the status of the cases to: ",headingStatusChangeVerification:"Status Change Verification",confirmProceed:"Are you sure you want to proceed?",confirmYes:"Yes",confirmNo:"No",stvPasswordIncorrect:"The password entered is incorrect.  Please try again.",stvEnterPasswordForStatusChange:"Please enter the password to continue with this action.",informationCurrentlyEditing:"Currently Editing",sanityCheckValidationInfo:"There are some data validation warnings/errors associated with this case.",dateLogicComparisonEvent:"Comparison event: ",dateLogicComparisonDate:"Comparison date: ",dateLogicDateToCompare:"Date to compare: ",dateLogicMessage:"Message: ",headingMoreInformation:"More information",headingNonMatchingCases:"Non-matching Cases",headingMultipleOpenActionCycles:"Multiple Open Action cycles",headingNoOpenActionInTheSameCriteria:"No Open Action of the same Criteria",headingInsufficientPermission:"You have not been granted update permission",headingBlockingNameRestriction:"Blocking name restrictions:",headingNameRestrictionRequiringPasswordApproval:"Name restrictions requiring password approval:",headingDataValidation:"Data Validation",headingCycleSelection:"Cycle Selection",csCaseForCycleSelection:"Case used to determine cycle selection: ",csCurrentOfficialNumber:"Current Official Number: ",csEvent:"Event: ",csRelativeCycle:"Select Relative Cycle to apply to all events: ",csCurrentCycle:"Current Cycle",csNextCycle:"Next Cycle",ucAdditionalInformation:"Additional Information",validationUnableToComplete:"Sorry, the action cannot be completed due to the following errors/warnings:",btnSaveCasesWithWarning:"Save cases with warnings",btnOk:"OK",btnCancel:"Cancel",tooltipDueDate:"{0}: Due Date",tooltipEventDate:"{0}: Event Date",tooltipEventText:"{0}: Event Text",confirmTitle:"Confirm",confirmUnsavedChanges:"You have unsaved changes. This action will reset the cases in the list.",changesSaved:"Changes are successfully saved.",changedPartiallySaved:"One or more cases were not saved. Review the results and try again.",validationFieldRequired:"This field is required",xhrLostConnection:"Lost connection to the server. ",xhrUnknownError:"An unknown error occurred.",errorHeading:"Error",errorSessionExpired:"Your session has expired, click Ok to login again.",entryAtleastOneDateRequired:"At least one date must be entered.",entryEventDateRequired:"Event Date is required",entryEventDateInFuture:"Event Date entered is a future date",entryDueDateRequired:"Due Date is required",entryEventTextRequiresAccompanyingDate:"Event text can only be entered with either an event date or a due date.",entryFileLocationRequired:"File location is required",entryDateLogicRuleViolated:"One or more date rules are violated.",entryFieldIsRequired:"'{0}' is required"}),localise.load("BatchEventUpdate/resources")}(BatchEventUpdateResources||{}),batchEventUpdate=function(a){"use strict";return a.appViewModel=function(a){var b=function(){var a=[saveMode.save,saveMode.acknowledgeWarningsAndSave];return d.currentView()&&a.any(function(a){return d.currentView().saveMode()===a})},c=batchEventUpdate.menuViewModel(a,b),d=$.extend(application.appBaseViewModel(),{menu:ko.observable(c),nonUpdatableCases:utils.sortable([])});return c.cases.subscribe(function(a){return a?(d.nonUpdatableCases(a.NonUpdatableCases.select(function(a){return batchEventUpdate.nonUpdatableCaseViewModel(a)})),void d.currentView(batchEventUpdate.spreadsheetViewModel(a.UpdatableCases,a.RequiresPasswordOnConfirmation,a.NewStatus,a.FileLocations,c.selectedAction().CriteriaId,c.selectedDataEntryTask().Id,c.selectedDataEntryTask().FileLocationId))):(d.currentView(null),void d.nonUpdatableCases([]))}),d},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.availableEventViewModel=function(a){var b=ko.mapping.fromJS(a);b.eventDate=utilities.observableDate(b.EventDate,function(a){b.IsStopPolicing(null!==a)}),b.dueDate=utilities.observableDate(b.DueDate),b.defaultDatesAreSet=!1;var c=(new Date).toDateString();return a.EventDateEntryAttribute.ShouldDefaultToSystemDate&&!a.EventDate&&(b.eventDate(c),b.defaultDatesAreSet=!0),a.DueDateEntryAttribute.ShouldDefaultToSystemDate&&!a.DueDate&&(b.dueDate(c),b.defaultDatesAreSet=!0),b},a}(batchEventUpdate||{}),caseState={loaded:"Loaded",loadedWithDefaults:"LoadedWithDefaults",dirty:"Dirty",saved:"Saved",reviewWarnings:"ReviewWarnings",reviewErrorsAndOrWarnings:"ReviewErrorsAndOrWarnings",warningsReviewed:"WarningsReviewed",errorsAndOrWarningsReviewed:"ErrorsAndOrWarningsReviewed"},batchEventUpdate=function(a){"use strict";return a.cycleSelectionViewModel=function(a,b,c,d,e,f){var g=application.modalDialogViewModel();return g=$.extend(g,{useNextCycle:ko.observable(null)}),httpClient.postJson("BatchEventUpdate/CycleSelection",{TempStorageId:a,CriteriaId:b,DataEntryTaskId:c},{success:function(a){var b={Events:{create:function(a){var b=ko.mapping.fromJS(a.data);return b.DueDateFormatted=utilities.observableDate(a.data.DueDate),b.EventDateFormatted=utilities.observableDate(a.data.EventDate),b}}};g.firstCase=ko.mapping.fromJS(a,b),d(g)}}),g.selectNextCycle=function(){g.useNextCycle(!0),g.close()},g.selectCurrentCycle=function(){g.useNextCycle(!1),g.close()},g.onClosedCallback=function(){e(),null!==g.useNextCycle()&&f(g.useNextCycle())},g},a}(batchEventUpdate||{});$(function(){"use strict";new Sammy(function(){this.get("/",function(){var a=utils.url.params().tempstorageid,b=batchEventUpdate.appViewModel(a);ko.applyBindings(b)}),this.get("",function(){this.app.runRoute("get","/")})}).run()});var batchEventUpdate=function(a){"use strict";return a.menuViewModel=function(a,b){var c={cases:ko.observable(null),openActions:ko.observable([]),shouldDisplayAllEntries:ko.observable(!1),cycleSelection:ko.observable()},d=function(a){var d=function(){c.cases(null),a.accept()};return c.cases()&&b()?void dialogs.confirm({title:localise.getString("confirmTitle"),message:localise.getString("confirmUnsavedChanges"),type:"warning",accept:d,reject:a.reject||function(){}}):void d()},e=function(b,d,f){httpClient.postJson("BatchEventUpdate/Events",{TempStorageId:a,CriteriaId:b,DataEntryTaskId:d,UseNextCycle:"undefined"==typeof f?"":f},{success:function(a){c.cases(a)},error:function(b){return b.status!==utils.httpStatusCode.ambiguous?!1:(batchEventUpdate.cycleSelectionViewModel(a,c.selectedAction().CriteriaId,c.selectedDataEntryTask().Id,function(a){c.cycleSelection(a)},function(){c.cycleSelection(null)},function(a){e(c.selectedAction().CriteriaId,c.selectedDataEntryTask().Id,a)}),!0)}})};return c.showMatchingCases=function(){d({accept:function(){e(c.selectedAction().CriteriaId,c.selectedDataEntryTask().Id)}})},c.selectedAction=ko.protectedObservable(null,d),c.selectedDataEntryTask=ko.protectedObservable(null,d),c.isSelectionValid=ko.computed(function(){return!(!c.selectedAction()||!c.selectedDataEntryTask())}),c.dataEntryTasks=ko.computed(function(){return c.selectedAction()?ko.utils.arrayFilter(c.selectedAction().DataEntryTasks,function(a){return c.shouldDisplayAllEntries()||!a.IsHidden}):[]}),c.toggleAllEntries=function(){c.selectedAction()&&c.shouldDisplayAllEntries(!c.shouldDisplayAllEntries())},c.hasHiddenEntries=ko.computed(function(){return c.selectedAction()?c.selectedAction().DataEntryTasks.any(function(a){return a.IsHidden===!0}):!1}),c.hasEntryInstructions=ko.computed(function(){return c.selectedDataEntryTask()?null!==c.selectedDataEntryTask().UserInstruction:!1}),httpClient.postJson("BatchEventUpdate/Menu",a,{success:function(a){var b=a.where(function(a){return a.IsOpen});c.openActions(b)}}),c},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.messages={unsavedCasesFlagChanged:"batch-event-update-unsaved-cases-flag-may-have-changed"},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.nonUpdatableCaseViewModel=function(a){var b=ko.mapping.fromJS(a),c=function(a){return b.CaseNameRestrictions().where(function(b){return b.Restrictions().any(function(b){return b.Severity()===a})})};return b.blockingNameRestrictions=function(){return c("Error")},b.nameRestrictionsRequiringPasswordApproval=function(){return c("Warning")},b},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.nonUpdatableViewModel=function(a){return utils.sortable(a)},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.saveCommand=function(a){var b=a.modifiedCases.select(function(b){var c=ko.mapping.toJS(b);return{CaseId:c.Id,ConfirmationPassword:a.passwordForStatusChange,ExternalDataValidationResult:b.externalDataValidationResult(),ControllingCycle:c.ControllingCycle,AreWarningsConfirmed:b.state()===caseState.reviewWarnings,SanityCheckResultIds:b.sanityCheckResultIds(),Data:[{Key:"batch-event-update",Value:JSON.stringify({Id:c.Id,OfficialNumber:c.OfficialNumber,AvailableEvents:c.AvailableEvents,FileLocationId:c.FileLocationId,WhenMovedToLocation:moment().format()})}]}});httpClient.postJson("BatchEventUpdate/Save",{CriteriaId:a.criteriaId,DataEntryTaskId:a.dataEntryTaskId,Cases:b},{success:a.then})},a}(batchEventUpdate||{});saveMode={none:"None",save:"Save",acknowledgeWarningsAndSave:"AcknowledgeWarningsAndSave"};var batchEventUpdate=function(a){"use strict";return a.spreadsheetViewModel=function(a,b,c,d,e,f,g){var h=application.windowViewModel("batch-event-update"),i=ko.observable(ko.utils.arrayMap(a,function(a){return batchEventUpdate.updatableCaseViewModel(a,g)})),j=function(){return h.newStatus()?k().any(function(a){return a.CaseStatusDescription()!==h.newStatus()}):!1},k=function(){return h.updatableCases().where(function(a){return a.isInState([caseState.loadedWithDefaults,caseState.dirty,caseState.reviewWarnings,caseState.warningsReviewed,caseState.errorsAndOrWarningsReviewed])&&a.isSelected()===!0})};$.extend(h,{confirmOnSave:ko.observable(),requiresPasswordOnConfirmation:ko.observable(b),validationResults:ko.observable(),newStatus:ko.observable(c),showOnlyWarnings:ko.observable(!1),showOnlyErrors:ko.observable(!1),filterErrors:ko.observable(!1),filterWarnings:ko.observable(!1),fileLocations:ko.observable(d)}),h.updatableCases=utils.sortable(ko.computed(function(){var a=i();if(h.filterErrors()===!1&&h.filterWarnings()===!1)return a;var b=[caseState.reviewErrorsAndOrWarnings,caseState.errorsAndOrWarningsReviewed],c=[caseState.reviewWarnings,caseState.warningsReviewed];return a.where(function(a){return h.filterErrors()===!0&&a.isInState(b)||h.filterWarnings()===!0&&a.isInState(c)})})),h.saveMode=ko.computed({read:function(){var a=k();return a.any()?a.any(function(a){return a.isInState([caseState.reviewWarnings])})?saveMode.acknowledgeWarningsAndSave:saveMode.save:saveMode.none}}),h.firstCase=ko.computed(function(){return h.updatableCases().firstOrDefault()}),h.applyChangesToAll=function(a,b){$.each(h.updatableCases(),function(c,d){if(0!==c){if("FileLocationId"===b)return void d.FileLocationId(h.updatableCases()[0].FileLocationId());var e=d.AvailableEvents().single(function(b){return b.EventId()===a.EventId()});e[b]()!==a[b]()&&e[b](a[b]())}})};var l=function(a){return h.filterErrors(!1),h.filterWarnings(!1),$.each(a,function(a,b){i().single(function(a){return b.CaseId===a.Id()}).update(b)}),a.all(function(a){return a.IsCompleted})?{message:localise.getString("changesSaved")}:{message:localise.getString("changedPartiallySaved")}};return h.submitChanges=function(){j()?h.confirmOnSave(batchEventUpdate.statusChangeConfirmationViewModel(k(),e,f,h.newStatus(),h.requiresPasswordOnConfirmation(),function(a){l(a.result)})):batchEventUpdate.saveCommand({modifiedCases:k(),criteriaId:e,dataEntryTaskId:f,then:l})},h.currentCase=ko.computed(function(){return i().firstOrDefault(function(a){return a.isActive()})}),h},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.statusChangeConfirmationViewModel=function(a,b,c,d,e,f){var g=application.modalDialogViewModel();return g=$.extend(g,{requiresPassword:ko.observable(e),password:ko.observable(),newStatus:ko.observable(d),isInvalidPassword:ko.observable(!1),cases:ko.observable(a)}),g.statusChangingCases=ko.computed(function(){return g.cases().where(function(a){return a.CaseStatusDescription()!==d})}),g.onConfirm=function(){batchEventUpdate.saveCommand({modifiedCases:g.cases(),criteriaId:b,dataEntryTaskId:c,passwordForStatusChange:g.password(),then:function(a){var b=function(b){return a.where(function(a){return a.ValidationResults.any(function(a){return"InvalidPasswordForStatusChange"===a.Details.Name})===b})};g.isInvalidPassword(b(!0).any());var c=b(!1),d=function(a,b){f({isCompleted:a,result:b})};g.isInvalidPassword()?(d(!1,c),g.cases(g.statusChangingCases())):(g.close(),d(!0,a))}})},g},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.updatableCaseViewModel=function(a,b){var c=function(a,b){if(e.state()===caseState.reviewWarnings)e.state(caseState.warningsReviewed);else if(e.state()===caseState.reviewErrorsAndOrWarnings)e.state(caseState.errorsAndOrWarningsReviewed);else{if(""===a&&!b||""===b&&!a)return;e.state(caseState.dirty)}},d={AvailableEvents:{create:function(a){return batchEventUpdate.availableEventViewModel(a.data)}}},e=ko.mapping.fromJS(a,d);e.isActive=ko.observable(!1),e.isInState=function(a){return a.any(function(a){return a===e.state()})};var f=ko.observable([]);e.externalDataValidationResult=ko.observable(),e.state=ko.observable(e.AvailableEvents().any(function(a){return a.defaultDatesAreSet})?caseState.loadedWithDefaults:caseState.loaded);var g=ko.observable(null);e.isSelected=ko.computed({read:function(){return e.isInState([caseState.loaded,caseState.reviewErrorsAndOrWarnings,caseState.saved])?(g(null),!1):null!==g()?g():!0},write:function(a){g(a)}}),e.disableSelectCheckBox=ko.computed(function(){return e.isInState([caseState.reviewErrorsAndOrWarnings,caseState.loaded,caseState.saved])}),$.each(e.AvailableEvents(),function(a,b){utils.koHelpers.subscribeToAny([e.OfficialNumber,b.EventDate,b.DueDate,b.EventText,e.FileLocationId],c)}),e.update=function(a){if(f(a.ValidationResults),a.IsCompleted)return e.state(caseState.saved),e.CaseStatusDescription(a.CaseStatusDescription),void e.CurrentOfficialNumber(a.CurrentOfficialNumber);if(a.ValidationResults.any(function(a){return"Error"===a.Severity}))e.state(caseState.reviewErrorsAndOrWarnings);else{if(!a.ValidationResults.any(function(a){return"Warning"===a.Severity}))throw"Unrecognized response received from server.";e.state(caseState.reviewWarnings)}},e.validationResults=ko.computed(function(){return e.isInState([caseState.dirty,caseState.warningsReviewed,caseState.errorsAndOrWarningsReviewed])?[]:e.isInState([caseState.saved])?f().where(function(a){return"Information"===a.Severity}):f()}),e.fieldValidationResults=function(a){return e.validationResults().where(function(b){return b.Details.InputName===a})},e.eventInputValidationResults=function(a,b){return ko.computed(function(){return e.validationResults().where(function(c){return"Event"===c.Details.EntityType&&c.Details.EntityId===a.EventId()&&c.Details.InputName===b})})};var h=function(a){return a.where(function(a){return"SanityCheckResult"===a.Details.Name})};return e.sanityCheckResults=ko.computed(function(){return h(e.validationResults())}),e.sanityCheckResultIds=function(){return e.validationResults().select(function(a){return a.Details.CorrelationId})},b&&(e.FileLocationId(b),e.state(caseState.dirty)),e},a}(batchEventUpdate||{}),batchEventUpdate=function(a){"use strict";return a.validationResultsViewModel=function(a){var b={results:ko.observable(a?a:[])};return b.hasWarnings=function(){return b.results().any(function(a){return a.IsWarning})},b.hasErrors=function(){return b.results().any(function(a){return!a.IsWarning})},b.hasErrorsOrWarnings=function(){return b.hasAnyWarnings()||b.hasAnyErrors()},b.hasOnlyWarnings=function(){return!b.hasAnyErrors()&&b.hasAnyWarnings()},b.hasCorrelatedWarnings=function(a){return b.results().any(function(b){return b.IsWarning&&b.CorrelationId===a})},b.hasCorrelatedErrors=function(a){return b.results().any(function(b){return!b.IsWarning&&b.CorrelationId===a})},b.hasCorrelatedErrorsOrWarnings=function(a,c){return b.hasGroupedErrors(a,c)||b.hasCorrelatedWarnings(a,c)},b.hasErrorsOfType=function(a,c){return b.results().any(function(b){return!b.IsWarning&&b.FieldId===a&&b.Type===c})},b.messageForField=function(a){return b.readMessage(function(b){return b.FieldId===a})},b.groupedMessage=function(a,c){return b.readMessage(function(b){return b.FieldId===c&&b.CorrelationId===a})},b.groupHasErrors=function(a){return b.results().any(function(b){return!b.IsWarning&&b.CorrelationId===a})},b.groupHasWarnings=function(a){return b.results().any(function(b){return b.IsWarning&&b.CorrelationId===a})},b.groupHasErrorsOrWarnings=function(a){return b.groupHasWarnings(a)||b.groupHasErrors(a)},b.correlatedErrorsAndWarnings=function(a){return ko.utils.arrayFilter(b.results(),function(b){return b.CorrelationId===a})},b.errorsAndWarningsFor=function(a){return ko.utils.arrayFilter(b.results(),function(b){return b.FieldId===a})},b.nameOrCreditRestrictions=function(a){return ko.utils.arrayFilter(b.results(),function(b){return b.FieldId===a})},b.readMessage=function(a){var c=b.results().firstOrDefault(a);return null===c?null:c.MessageId?localise.getString(c.MessageId)||c.Message:c.Message},b.getErrorsForSpecifiedType=function(a,c){return b.results().where(function(b){return!b.IsWarning&&b.FieldId===a&&b.Type===c})},b},a}(batchEventUpdate||{});ko.bindingHandlers.colspan={init:function(a,b){"use strict";var c=b();if(c){var d=(c.IsCyclic()===!0?1:0)+(c.EventDateEntryAttribute.IsVisible()?1:0)+(c.DueDateEntryAttribute.IsVisible()?1:0)+1;$(a).attr("colspan",d)}}},ko.bindingHandlers.translate={update:function(a,b,c){"use strict";localise&&localise.loaded()&&$(a).text(localise.getString(b()))}},ko.bindingHandlers.translateOptionsCaption={update:function(a,b,c){"use strict";if(localise&&localise.loaded()){var d=c().optionsCaption;d&&($("option:first",$(a)).text(localise.getString(b())),c().optionsCaption=localise.getString(b()))}}},ko.bindingHandlers.translateTooltip={update:function(a,b,c){"use strict";if(localise&&localise.loaded())return"object"==typeof b()?void $(a).prop("title",localise.getString(b().id,b().args)):void $(a).prop("title",localise.getString(b()))}},$(function(){postInitialization.showContent(),postInitialization.adjustWorkArea(),postInitialization.setDateFormat()});var postInitialization=function(a,b){return a.setDateFormat=function(){var a=$("#profile-settings-language").val();a&&-1!=a.indexOf("en-us")&&(Date.CultureInfo.dateElementOrder="mdy"),b.setInternationalizationUrl(utilities.appBaseUrl("scripts/datejs/i18n/")),ko.postbox.subscribe("applicationDetail",function(a){a&&a.currentUser&&a.currentUser.preferences&&b.setLanguage(a.currentUser.preferences.Culture)})},a}(postInitialization||{},dateFormatting),postInitialization=function(a){return a.showContent=function(){$("#content").show()},a}(postInitialization||{}),postInitialization=function(a){return a.adjustWorkArea=function(){var a=function(){var a=$(".work-area-container"),b=$(".navbar-fixed-top"),c=$(".work-area-container > .work-area > .toolbar"),d=$(".work-area-container > .work-area > .header"),e=$(".work-area-container > .work-area > .body"),f=$(".headerTitle"),g=500,h=40,i=30,j=function(){return(0==b.length?0:b.height())+(0==c.length?i:c.height())+(0==d.length?0:d.height())+(0==f.length?0:f.height())+h},k=j(),l=function(){var b=j();k!=b&&(e.height(a.height()-b),k=b)},m=function(){e.height(a.height()-j())},n=function(){l(),setTimeout(n,g)},o=function(a){var e=new a(function(){l()}),f={subtree:!0,childList:!0};0!=b.length&&e.observe(b[0],f),0!=c.length&&e.observe(c[0],f),0!=d.length&&e.observe(d[0],f)},p=function(){setTimeout(n,g)};MutationObserver=window.MutationObserver||window.WebKitMutationObserver,MutationObserver?o(MutationObserver):p(),$(window).resize(function(){m()}),m()};a()},a}(postInitialization||{});