rem @echo off

REM scan for vulnerability. If this file exists it is called by team city to build
REM the client applications

REM build condor client dist
pushd "%~dp0\condor"

echo ##teamcity[blockOpened name='making condor']
call make.bat %*
IF NOT %ERRORLEVEL% EQU 0 (
	echo ##teamcity[message text='making condor failed' errorDetails='%ERRORLEVEL%' status='ERROR']
	echo ##teamcity[blockClosed name='making condor']
	exit /b %ERRORLEVEL%
)
echo ##teamcity[blockClosed name='making condor']

echo ##teamcity[blockOpened name='Update retirejs to the latest']
call npm update -g retire@latest
echo ##teamcity[blockClosed name='Update retirejs to the latest']

echo ##teamcity[blockOpened name='Scanning condor for vulnerability']
call gulp scan --path="..\Build\Content\Inprotech.Server\client"
IF NOT %ERRORLEVEL% EQU 0 (
	echo ##teamcity[message text='Scanning condor for vulnerability failed' errorDetails='%ERRORLEVEL%' status='ERROR']
	echo ##teamcity[blockClosed name='Scanning condor for vulnerability']
	exit /b %ERRORLEVEL%
)
echo ##teamcity[blockClosed name='Scanning condor for vulnerability']
popd
